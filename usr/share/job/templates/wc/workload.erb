# ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
#  >>>> SET TASK ENVIRONMENT VARIABLES
# ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
# If necessary, set up further environment variables that are not
# specific to your workload here.
#
# Several standard variables, such as SLURM_JOB_ID, SLURM_JOB_NAME and
# SLURM_NTASKS, are made available by the scheduler.

# ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
#  >>>> YOUR WORKLOAD
# ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░

#===============================
#  Activate Flight Environment
#-------------------------------
source "${flight_ROOT:-/opt/flight}"/etc/setup.sh

#==============================
#  Activate Package Ecosystem
#------------------------------
# e.g.:
# flight env activate gridware
# module load apps/imb

#===========================
#  Create results directory
#---------------------------
# By convention, job's submitted with `flight-job` are expected to save their
# results to RESULTS_DIR.  `flight-job` provides easy access to any files
# saved there.
#
# Your job can save its results anywhere you want, but if the results are
# saved outside of RESULTS_DIR (or if RESULTS_DIR is modified), 'flight-job'
# will be unable to help you access your results.
#
# RESULTS_DIR has already been set to "$WORKING_DIR/${SLURM_JOB_NAME}-outputs/$SLURM_JOB_ID"
echo "Your results will be stored in: $RESULTS_DIR"
mkdir -p "$RESULTS_DIR"

#===============================
#  Application launch commands
#-------------------------------
# Customize this section to suit your needs.

echo "Executing job commands, current working directory is $(pwd)"
echo

# REPLACE THE FOLLOWING WITH YOUR APPLICATION COMMANDS

process_file() {
  echo "Processing file $(basename $1) in directory $(dirname $1)..."
  wc $1 >> $RESULTS_DIR/test.output
  md5sum $1 >> $RESULTS_DIR/test.output
}

<% if questions.main_input_file.answer.nil? -%>
# No main input file given.
<% else -%>
# Process a single input file.
input_file=<%= questions.main_input_file.answer %>
process_file $input_file
<% end -%>

<% if questions.more_input_file.answer.empty? -%>
# No additional input files given.
<% else -%>
# Process additional input files.
<% questions.more_input_file.answer.each do |input_file| -%>
input_file=<%= input_file %>
process_file $input_file
<% end -%>
<% end -%>

echo
echo "Output file has been generated, please check $RESULTS_DIR/test.output"
